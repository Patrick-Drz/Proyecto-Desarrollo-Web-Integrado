<div class="container-fluid p-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold text-dark m-0">Gestión de Usuarios</h2>
    <button class="btn btn-primary btn-sm" (click)="exportarCSV()">
      <i class="fa-solid fa-download me-2"></i>Descargar Reporte
    </button>
  </div>

  <div class="row g-4 mb-4">
    <div class="col-md-3">
      <div class="card border-0 shadow-sm border-start border-4 border-primary h-100">
        <div class="card-body">
          <div class="text-xs fw-bold text-primary text-uppercase mb-1">Total Usuarios</div>
          <div class="h5 mb-0 fw-bold text-gray-800">{{ stats.total || 0 }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-0 shadow-sm border-start border-4 border-success h-100">
        <div class="card-body">
          <div class="text-xs fw-bold text-success text-uppercase mb-1">Activos</div>
          <div class="h5 mb-0 fw-bold text-gray-800">{{ stats.activos || 0 }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-0 shadow-sm border-start border-4 border-danger h-100">
        <div class="card-body">
          <div class="text-xs fw-bold text-danger text-uppercase mb-1">Bloqueados</div>
          <div class="h5 mb-0 fw-bold text-gray-800">{{ stats.inactivos || 0 }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-body p-2 d-flex align-items-center justify-content-center" style="height: 100px;">
          <canvas baseChart
                  [data]="pieChartData"
                  [options]="pieChartOptions"
                  [type]="'pie'">
          </canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm mb-4 border-0">
    <div class="card-header bg-white py-3">
      <h6 class="m-0 fw-bold" [ngClass]="editMode ? 'text-warning' : 'text-primary'">
        {{ editMode ? 'Editar Usuario' : 'Registrar Nuevo Usuario' }}
      </h6>
    </div>
    <div class="card-body">
      <form [formGroup]="userForm" (ngSubmit)="onSubmit()">
        <div class="row">
          <div class="col-md-4 mb-3">
            <label class="form-label small text-muted">Nombre Completo</label>
            <input type="text" class="form-control" formControlName="nombreCompleto" placeholder="Ej: Juan Perez">
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label small text-muted">Correo Electrónico</label>
            <input type="email" class="form-control" formControlName="correo" placeholder="correo@utp.edu.pe">
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label small text-muted">
              Contraseña <span *ngIf="editMode" class="text-info fst-italic">(Opcional)</span>
            </label>
            <input type="password" class="form-control" formControlName="contrasena" placeholder="******">
          </div>
        </div>
        <div class="row">
          <div class="col-md-3 mb-3">
            <label class="form-label small text-muted">Rol</label>
            <select class="form-select" formControlName="rol">
              <option value="CLIENTE">Estudiante (Cliente)</option>
              <option value="ADMINISTRADOR">Administrador</option>
            </select>
          </div>
          <div class="col-md-3 mb-3">
            <label class="form-label small text-muted">Código Estudiante</label>
            <input type="text" class="form-control" formControlName="codigoEstudiante" placeholder="U123456">
          </div>
          <div class="col-md-6 mb-3 d-flex align-items-end justify-content-end gap-2">
            <button type="button" class="btn btn-light" *ngIf="editMode" (click)="cancelEdit()">Cancelar</button>
            <button type="submit" class="btn" [ngClass]="editMode ? 'btn-warning' : 'btn-primary'" [disabled]="userForm.invalid">
              <i class="fa-solid fa-save me-1"></i> {{ editMode ? 'Actualizar' : 'Guardar' }}
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="card shadow-sm border-0">
    <div class="card-header bg-white py-3 d-flex flex-wrap justify-content-between align-items-center gap-3">
      <h6 class="m-0 fw-bold text-dark">Directorio de Usuarios</h6>

      <div class="d-flex gap-2">
        <input type="text" class="form-control form-control-sm" placeholder="Buscar por nombre, correo..."
               [(ngModel)]="filtroTexto" (input)="aplicarFiltros()" style="width: 200px;">

        <select class="form-select form-select-sm" [(ngModel)]="filtroRol" (change)="aplicarFiltros()" style="width: 150px;">
          <option value="TODOS">Todos los roles</option>
          <option value="CLIENTE">Clientes</option>
          <option value="ADMINISTRADOR">Administradores</option>
        </select>

        <label class="btn btn-outline-success btn-sm">
          <i class="fa-solid fa-file-csv"></i> Importar
          <input type="file" hidden (change)="importarCSV($event)" accept=".csv">
        </label>
      </div>
    </div>

    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
          <tr>
            <th class="ps-4">Usuario</th>
            <th>Rol</th>
            <th>Código</th>
            <th>Estado</th>
            <th>Registro</th>
            <th class="text-end pe-4">Acciones</th>
          </tr>
          </thead>
          <tbody>
          <tr *ngFor="let u of usuariosFiltrados">
            <td class="ps-4">
              <div class="fw-bold text-dark">{{u.nombreCompleto}}</div>
              <div class="small text-muted">{{u.correo}}</div>
            </td>
            <td>
                                <span class="badge fw-normal"
                                      [ngClass]="u.rol === 'ADMINISTRADOR' ? 'bg-primary-subtle text-primary border border-primary' : 'bg-light text-dark border'">
                                    {{u.rol}}
                                </span>
            </td>
            <td class="small">{{u.codigoEstudiante || '---'}}</td>
            <td>
                                <span class="badge rounded-pill"
                                      [ngClass]="u.activo ? 'bg-success' : 'bg-danger'">
                                    {{u.activo ? 'Activo' : 'Bloqueado'}}
                                </span>
            </td>
            <td class="small text-muted">{{u.fechaRegistro | date:'shortDate'}}</td>
            <td class="text-end pe-4">
              <button class="btn btn-sm btn-link text-primary p-0 me-3" (click)="editar(u)" title="Editar">
                <i class="fa-solid fa-pen"></i>
              </button>
              <button class="btn btn-sm btn-link p-0"
                      [ngClass]="u.activo ? 'text-danger' : 'text-success'"
                      (click)="bloquear(u.id!)"
                      [title]="u.activo ? 'Bloquear cuenta' : 'Desbloquear cuenta'">
                <i class="fa-solid" [ngClass]="u.activo ? 'fa-lock' : 'fa-lock-open'"></i>
              </button>
            </td>
          </tr>
          <tr *ngIf="usuariosFiltrados.length === 0">
            <td colspan="6" class="text-center py-5 text-muted">
              No se encontraron usuarios con los filtros actuales.
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
